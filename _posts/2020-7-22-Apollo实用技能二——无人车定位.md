---
title: Apollo实用技能二——无人车定位
tags:
  - 百度
  - 无人驾驶
---

# Apollo实用技能二——无人车定位

一、三维几何变换

​	**坐标系：根据各个轴的位置不同，空间中的坐标系可以分为左手坐标系和右手坐标系**

![](\JODE-HRK.github.io\assets\image\三维几何坐标系.jpg)

​	**旋转：旋转是指在一个坐标系下，把一个点旋转到另一个位置的几何变换。**

![](\JODE-HRK.github.io\assets\image\三维几何变换旋转.jpg)

如上所示：将P旋转θ角到P'的位置,在二维坐标系下，由一个2×2的矩阵表示，如图中的R(θ)。点的旋转其实也可以理解为两个坐标系的一个旋转。对于三维而言，多了一个维度，可以用3×3矩阵来表示。

分解来看，可以通过X轴Y轴Z轴分别去旋转，对应的分量分别是RX，RY和RZ。三维旋转矩阵可以由对应三个方向的基本旋转矩阵相乘来表示。三维旋转矩阵存在九个元素，对九个元素进行优化是非常复杂。通常情况下会使用是欧拉角或者四元数的方式进行优化，如下图所示。

![](\JODE-HRK.github.io\assets\image\三维旋转.jpg)

​	

​	**平移：平移是当前点相对于坐标原点的位置变化，通常由当前位置的坐标表示，由一个3x1的向量表示。**
![](\JODE-HRK.github.io\assets\image\三维平移.jpg)

​	**刚体位置与朝向：**

![](\JODE-HRK.github.io\assets\image\刚体的位置和朝向.jpg)

刚体是一种有限尺寸，可以忽略形变的固体。自然界不存在完美的刚体，但物体通常可以假定为完美刚体。自动驾驶中汽车可以认为是一个刚体。

刚体坐标系通常是取刚体内的一点P为原点建立的局部坐标系。刚体的位置可以看作刚体原点P相对于参考坐标系原点O所做的平移，可以使用三维平移向量表示。刚体的朝向可以由刚体原点P的朝向来表示。

二、坐标系

​	**ECI地心惯性坐标系：也称i系，这个坐标系如下图所示：**

![](\JODE-HRK.github.io\assets\image\地心惯性坐标系.jpg)

它圆心就是地球的原点，Z轴沿地轴方向朝向北极， X轴和Y轴位于赤道平面内，与Z轴满足右手法则，并且X轴和Y轴分别指向两个恒星。也就是说不随着地球的自转而发生变化。它是一个非常固定的坐标系。IMU测量得到的加速度，角速度都是相对于这个坐标系的。

**ECEF地心地固坐标系**

![](\JODE-HRK.github.io\assets\image\地心地固坐标系.jpg)

ECEF地心地固坐标系也称为e系，它的原点也是地球的原点， Z轴指向北极， 它与前面的ECI的区别就在于它的XY随着地球的自转而转动，它是以地球为基准的。它的X轴指向格林威治的子午面的交线， Y轴在赤道平面内与X轴、Z轴满足右手系法则，常用的如WGS84坐标系。其特点是与地球固定在一起，随地球一起转动。

**当地水平坐标系**

![](\JODE-HRK.github.io\assets\image\当地水平坐标系.jpg)

当地水平坐标系，一般也称为L系。如下图所示，它的原点位于载体所在的地球表面，X轴和Y轴在当地水平面内，分别指向东向和北向，Z轴垂直向上，与X轴和Y轴满足右手法则。在导航解算过程中通常也把该坐标系选取为导航坐标系（n系），也称为“东-北-天（E-N-U）”坐标系。

**UTM坐标系**

![](\JODE-HRK.github.io\assets\image\UTM坐标系.jpg)

UTM(UNIVERSAL TRANSVERSE MERCARTOR GRIDSYSTEM，通用横轴墨卡托格网系统)坐标是一种平面直角坐标，这种坐标格网系统及其所依据的投影已经广泛用于地形图。其投影是一种“等角横轴割圆柱投影”，椭圆柱割地球与南纬80度，北纬84度两条等高圈，投影后两条相割的经线上没有变形，而中央经线上长度比为0.9996。该投影方法按经度把地球划分成了60个区域，那么每6度一个区域，例如北京其实在第50区。南北又做了划分，相当于把地球划分成很多块。

**车体坐标系**

车体坐标系原点在载体质量中心与载体固连处（相对于车载，选取原点位于后轴中心位置），X轴沿载体轴向指向右，Y轴指向前，Z轴与X轴和Y轴满足右手法则指向天向。该坐标系通常称为“右-前-上（R-F-U）”坐标系。它是一个局部坐标系，它与N系或者导航坐标系、当地水平坐标系之间的旋转关系表示现在车的姿态。

![](\JODE-HRK.github.io\assets\image\车体坐标系.jpg)

**IMU坐标系**

IMU坐标系其实和车体坐标系基本上是一样，它的原点在陀螺仪和加速度计的坐标原点，XYZ三个轴方向分别与陀螺仪和加速度计对应的轴向平行。在不考虑安装误差角的情况下，载体坐标系和IMU坐标系是一样的。

![](\JODE-HRK.github.io\assets\image\IMU坐标系.jpg)

**相机坐标系**

相机坐标系以相机光心为原点，Xc轴和Yc轴与成像平面坐标系的x轴和y轴平行，Zc轴为摄像机的光轴，和图像平面垂直。由点O与Xc、Yc、Zc轴组成的坐标系成为相机的坐标系，如下图右边所示。通常情况下并不会将相机坐标系和其他的全局坐标系直接连接起来，因为已经选IMU作为汽车原点。通过一个外参，把相机和IMU关联起来，也就是标定的外部参数。当知道IMU在世界坐标系的姿态和位置就可以得到相机坐标系到世界坐标系的转换。

![](\JODE-HRK.github.io\assets\image\相机坐标系.jpg)

**激光雷达坐标系**

下图为激光雷达坐标系以及其俯视图，从图中可以看出激光雷达坐标系的坐标原点位于多线束中点旋转轴的交点处，Z轴沿轴线向上，X和Y轴如俯视图所示。其测量的点坐标是在激光雷达坐标系下的三维坐标。

要转换到世界坐标系，可以使用相机坐标系下点转换到世界坐标系的类似方法。通过IMU坐标系到激光雷达坐标系的外參，以及IMU坐标系的姿态，得到激光雷达坐标系到世界坐标系的转换。

![](\JODE-HRK.github.io\assets\image\激光雷达坐标系.jpg)

 ## 总结：无人车中所涉及的坐标系

![](\JODE-HRK.github.io\assets\image\无人车定位信息中涉及的坐标系.jpg)

定位输出信息主要包括UTM坐标系的XY,IMU的姿态四元数， ENU坐标系下的速度。另外还输出一些和车体相关信息，例如车体姿态的四元数，车体坐标系下的加速度和角速度。这些输出的信息可以给感知和PNC使用。各个坐标系之间是一些基本的旋转关系。


三、百度无人车的定位技术

**定位的目的是让自动驾驶汽车找到自身确切位置的方法，可以说，定位导航技术是整个自动驾驶技术的核心。**

卫星导航定位精度误差在10米左右，这对于自动驾驶是致命的，完全不能满足自动驾驶的需求。如果驾驶的周围环境复杂，过桥洞，接收不了导航信号，遮蔽严重，如高楼、山脉，会产生多径效应，导航的精度可能会更差，有可能会超过50米。所以无人驾驶系统不能依赖卫星导航系统，因此需要借助其他方式方法来提高车辆在地图上的位置精度，这就要配合高精地图，融合惯导和视觉等技术。

先进的无人车方案肯定不能完全基于RTK，百度Apollo系统使用了激光雷达、RTK与IMU融合的方案，多种传感器融合加上一个误差状态卡尔曼滤波器使得定位精度可以达到5-10厘米，且具备高可靠性和鲁棒性，达到了全球顶级水平。市区允许最高时速超过每小时60公里。 

**百度自动驾驶使用的定位技术**

自动驾驶中，在不同的传感器配置下，都需要做到定位的准确性。下面介绍在百度无人车系统中使用的定位技术，主要分为四个部分，GNSS定位技术，载波定位技术，激光点云定位技术和视觉定位技术。

**GNSS定位技术**

GNSS定位技术中最著名的是GPS。GPS最早是由美国建立的，有24颗GPS卫星，两个频率的波段。GPS具有定位、测速、授时等功能。

类似的系统还有北斗定位，俄罗斯的格罗纳斯和欧洲的伽利略定位。它们的原理是测距，有三颗卫星就可以交会两点，舍弃外部的空间点就可以得到自己测绘这个点。但是一般情况下，由于钟差，一般需要四颗卫星去做误差剔除。

GNSS定位其实是单点定位，没有用到基站，它的精度一般是5到10米。为了能够得到更精准的定位精度，引入了一些更好的方式，如载波定位技术。

**载波定位技术**

载波定位技术具体分为两类，RTK技术和PPP技术。它们都是为了确定载波的整周数，然后消除噪声，达到更精准的定位。

RTK的工作原理如下：卫星把观测数据给基站，也给车端的移动站。基站根据多个卫星的钟差计算出误差项，然后把误差项传递给车端，车端用这个误差项消除观测误差，得到精准的位置。它的问题是硬件成本高，需要建基站，需要4G通信的链路，需要基站传数据。

PPP可以简单理解为一个很强的单点，它有很多种基础基站的建设。这些基站通过卫星数据，把这些误差都在基站做分离处理，再传递给卫星。卫星已经做了误差的消除，再去对车端进行定位，得到一个非常高精度的定位信息。

![](\JODE-HRK.github.io\assets\image\载波定位技术.jpg)

GNSS在无人车中的作用，大概可以分为三个部分，第一个部分是GPS授时。 第二是制作高精地图。第三是RTK在线定位，作为定位的一个模块使用

**GNSS的问题是可靠性，很容易受到电磁环境干扰。第二点就是对于比较差的环境，比如城市的高楼、峡谷、林荫路，对GNSS影响都很大。**

 **激光点云定位技术**

![](\JODE-HRK.github.io\assets\image\激光点云定位技术.jpg)

激光点云定位系统包括两个模块：图像对齐和SSD HF。图像对齐模块主要是用于航向角的优化。点云定位里面会输出四个维度的信息，XYZ和Yaw（航向角）。

首先做航向角的优化，然后SSD-HF做XY优化，Z则由定位地图提供。定位地图是一种数据的的存储方式。激光点云定位的输入还包括预测位姿和实时点云数据。输出信息将会给融合算法，进行更加精确的定位。

**视觉定位技术**

视觉定位的输出也是XYZ和Yaw，即位置和朝向。视觉定位通过摄像头识别图像中具有语义信息的稳定特征并与地图做匹配，得到位置和朝向信息。视觉定位算法的流程图如下所示。

![](\JODE-HRK.github.io\assets\image\视觉定位技术.jpg)

视觉定位的流程主要包含三个部分，一是3D特征地图的离线的生成，第二是图像特征的检测，最后是数据的整合输出。

首先是摄像头进行图像特征的检测，主要是进行车道线和杆状物的检测。通过GPS给出的初始位置，基于初始位置对3D地图和摄像头检查到的信息进行特征匹配。用IMU和轮速计去做姿势的预测，给出一个不错的姿势。最后的结果输出给融合模块，融合可以将GPS、视觉定位、IMU数据整合，优化定位结果并提供高频输出。